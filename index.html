<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APG Test Page (GPT Stub)</title>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;line-height:1.35}
    code,pre{background:#f4f4f6;padding:2px 6px;border-radius:6px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
    button{padding:10px 12px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    button:hover{background:#fafafa}
    .box{border:1px solid #e6e6e6;border-radius:14px;padding:14px;margin-top:14px}
    .slots{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:10px}
    .slot{border:1px dashed #bbb;border-radius:12px;min-height:90px;display:flex;align-items:center;justify-content:center;color:#666;padding:10px;text-align:center}
    .small{font-size:12px;color:#666}
    .warn{color:#c70}
    .bad{color:#c00}
  </style>

  <!-- =========================================================
       0) GPT STUB (unchanged)
       ========================================================= -->
  <script>
  (function () {
    const listeners = { slotRenderEnded: [] };

    function makeSlot({ id, adUnitPath, sizes }) {
      return {
        getSlotElementId() { return id; },
        getAdUnitPath() { return adUnitPath; },
        getSizes() {
          return (sizes || []).map(([w,h]) => ({
            getWidth(){ return w; },
            getHeight(){ return h; }
          }));
        }
      };
    }

    const slots = [
      makeSlot({ id:"div-gpt-ad-test-1", adUnitPath:"/12345678/homepage/top", sizes:[[728,90],[970,250]] }),
      makeSlot({ id:"div-gpt-ad-test-2", adUnitPath:"/12345678/homepage/sidebar", sizes:[[300,250],[300,600]] }),
      makeSlot({ id:"slot-wrong-network", adUnitPath:"/99999999/homepage/bad-network", sizes:[[300,250]] }),
      makeSlot({ id:"gpt-ad-footer", adUnitPath:"/12345678/homepage/footer", sizes:[[728,90]] })
    ];

    const pubadsObj = {
      addEventListener(evt, cb) {
        if (!listeners[evt]) listeners[evt] = [];
        listeners[evt].push(cb);
      },
      getSlots() { return slots; },
      __emitSlotRenderEnded(payload) {
        (listeners.slotRenderEnded || []).forEach(cb => { try { cb(payload); } catch(e){} });
      }
    };

    const gt = window.googletag || {};
    gt.apiReady = true;
    gt.cmd = gt.cmd || [];
    const origPush = gt.cmd.push.bind(gt.cmd);
    gt.cmd.push = function (fn) { origPush(fn); try{ fn(); }catch(e){}; };

    gt.pubads = () => pubadsObj;
    window.googletag = gt;

    window.__gptStub = {
      emitEmpty() {
        const slot = slots[0];
        pubadsObj.__emitSlotRenderEnded({ slot, isEmpty:true });
      },
      emitUnexpectedSize() {
        const slot = slots[1];
        pubadsObj.__emitSlotRenderEnded({ slot, isEmpty:false, size:[160,600] });
      }
    };
  })();
  </script>

  <!-- =========================================================
       1) APG TAG — UPDATED (start-1.0.4)
       ========================================================= -->
  <script>
  (function () {
    const CONFIG = {
      clientId: 'client-001',
      allowedDomain: 'smajli12.github.io',
      expectedNetworkId: '12345678',
      apiEndpoint: 'https://apg-api.onrender.com/ingest',
      siteToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjbGllbnRJZCI6ImNsaWVudC0wMDEiLCJpYXQiOjE3NjcyMDc4NjAsImV4cCI6MTc5ODc0Mzg2MH0.75Fih1agPeA_QTK3u3qpydbLuMAfr4_TqeoApKB6tAY',
      version: 'start-1.0.4',

      sendTimeoutMs: 4000,
      dedupeTtlMs: 24 * 60 * 60 * 1000,
      postLoadDelayMs: 3500,

      domSlotSelector:
        'div[id^="div-gpt-ad"],div[id^="gpt-"],div[id^="ad-"],div[id*="ad-slot"],div[id*="gpt-ad"],div[id*="slot"]',

      revenueModel: {
        currency: 'USD',
        assumedRpm: 1,
        assumedImpressionsPerHour: 500
      }
    };

    const host = location.hostname;
    if (!(host === CONFIG.allowedDomain || host.endsWith('.' + CONFIG.allowedDomain))) return;

    function severityFor(t){
      return ['gpt_not_loaded','wrong_network','slot_not_registered'].includes(t) ? 'high' :
             ['empty_response','unexpected_size'].includes(t) ? 'medium' : 'low';
    }

    function estimateRevenueRisk(){
      const rpm = CONFIG.revenueModel.assumedRpm;
      const imps = CONFIG.revenueModel.assumedImpressionsPerHour;
      const hourly = (imps / 1000) * rpm;
      return {
        estimationCurrency: CONFIG.revenueModel.currency,
        assumedRpm: rpm,
        assumedImpressionsPerHour: imps,
        estimatedHourlyRevenueRisk: Math.round(hourly * 100) / 100,
        estimatedDailyRevenueRisk: Math.round(hourly * 24 * 100) / 100,
        estimationMethod: 'conservative_time_based_risk',
        revenueAssumptionsNote:
          '500 impressions/hour, $1 RPM (conservative minimum). Indicative only.'
      };
    }

    async function sendIssue(issue){
      const payload = Object.assign({
        clientId: CONFIG.clientId,
        host: location.hostname,
        pageUrl: location.href,
        timestamp: new Date().toISOString(),
        tagVersion: CONFIG.version,
        userAgent: navigator.userAgent
      }, issue, { severity: severityFor(issue.issueType) }, estimateRevenueRisk());

      try {
        await fetch(CONFIG.apiEndpoint,{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':`Bearer ${CONFIG.siteToken}`,
            'X-APG-Tag-Version':CONFIG.version
          },
          body:JSON.stringify(payload),
          keepalive:true
        });
      } catch(e){}
    }

    (window.googletag = window.googletag || { cmd: [] }).cmd.push(function(){
      if (!googletag.apiReady) {
        sendIssue({ issueType:'gpt_not_loaded' });
        return;
      }

      const pubads = googletag.pubads();
      pubads.addEventListener('slotRenderEnded', e => {
        const slotId = e.slot?.getSlotElementId?.() || '';
        const adUnitPath = e.slot?.getAdUnitPath?.() || '';

        if (e.isEmpty) sendIssue({ issueType:'empty_response', slotId, adUnitPath });
        if (e.size && !e.slot.getSizes().some(s => s.getWidth()==e.size[0] && s.getHeight()==e.size[1])) {
          sendIssue({ issueType:'unexpected_size', slotId, adUnitPath });
        }
      });

      setTimeout(() => {
        googletag.pubads().getSlots().forEach(s => {
          const nid = s.getAdUnitPath().split('/')[1];
          if (nid !== CONFIG.expectedNetworkId) {
            sendIssue({ issueType:'wrong_network', slotId:s.getSlotElementId(), adUnitPath:s.getAdUnitPath() });
          }
        });
      }, CONFIG.postLoadDelayMs);
    });
  })();
  </script>
</head>

<body>
  <h1>APG Test Page</h1>

  <div class="box">
    <h2>Slots in DOM</h2>

    <div class="slots">
      <!-- Registered slots -->
      <div class="slot" id="div-gpt-ad-test-1">
        Registered<br><span class="small">div-gpt-ad-test-1</span>
      </div>

      <div class="slot" id="div-gpt-ad-test-2">
        Registered<br><span class="small">div-gpt-ad-test-2</span>
      </div>

      <div class="slot" id="slot-wrong-network">
        <span class="bad">WRONG NETWORK</span><br>
        <span class="small">slot-wrong-network</span>
      </div>

      <div class="slot" id="gpt-ad-footer">
        Registered<br><span class="small">gpt-ad-footer</span>
      </div>

      <!-- ❌ Intentionally NOT registered in GPT -->
      <div class="slot" id="ad-slot-not-registered">
        <span class="warn">NOT registered in GPT</span><br>
        <span class="small">ad-slot-not-registered</span>
      </div>
    </div>
  </div>

  <div class="box">
    <h2>Trigger slotRenderEnded (listener test)</h2>
    <div class="row">
      <button onclick="__gptStub.emitEmpty()">Emit empty_response</button>
      <button onclick="__gptStub.emitUnexpectedSize()">Emit unexpected_size</button>
    </div>
  </div>

  <p class="small">
    DevTools → Network → filter <code>ingest</code><br/>
    Očekuj:
    <code>wrong_network</code>,
    <code>slot_not_registered</code>,
    <code>empty_response</code>,
    <code>unexpected_size</code>
  </p>
</body>
</html>
