<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>APG Real-World Test</title>
  <style>
    body{font-family:system-ui;margin:24px}
    .slot{border:1px dashed #999;padding:12px;margin:8px}
  </style>
</head>

<body>
  <h1>APG Test Page</h1>

  <div class="slot" id="div-gpt-ad-test-1">Registered</div>
  <div class="slot" id="div-gpt-ad-test-2">Registered</div>

  <div class="slot" id="div-gpt-ad-not-registered">
    ‚ùå NOT REGISTERED IN GPT
  </div>

  <!-- GPT STUB -->
  <script>
    (function(){
      const slots = [
        { id:'div-gpt-ad-test-1', path:'/12345678/test/top' },
        { id:'div-gpt-ad-test-2', path:'/12345678/test/sidebar' }
      ];
      window.googletag = {
        apiReady:true,
        cmd:{ push(fn){ fn(); }},
        pubads(){
          return {
            getSlots(){ return slots.map(s=>({
              getSlotElementId(){return s.id},
              getAdUnitPath(){return s.path},
              getSizes(){return [{getWidth(){return 300},getHeight(){return 250}}]}
            }))},
            addEventListener(){}
          };
        }
      };
    })();
  </script>

  <!-- APG TAG -->
  <!-- (paste tag from section 1 here) -->
<script>
(function () {
  const CONFIG = {
    clientId: 'client-001',
    allowedDomain: 'smajli12.github.io',
    expectedNetworkId: '12345678',
    apiEndpoint: 'https://apg-api.onrender.com/ingest',
    siteToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjbGllbnRJZCI6ImNsaWVudC0wMDEiLCJpYXQiOjE3NjcyMDc4NjAsImV4cCI6MTc5ODc0Mzg2MH0.75Fih1agPeA_QTK3u3qpydbLuMAfr4_TqeoApKB6tAY',
    version: 'start-1.1.0',

    scanScheduleMs: [3500, 10000, 20000], // retries
    dedupeTtlMs: 24 * 60 * 60 * 1000,

    domSlotSelector:
      'div[id^="div-gpt-ad"],div[id^="gpt-"],div[id^="ad-"],div[id*="ad-slot"],div[id*="gpt-ad"],div[id*="slot"]',

    revenueModel: {
      currency: 'USD',
      assumedRpm: 1,
      assumedImpressionsPerHour: 500
    }
  };

  const host = location.hostname;
  if (!(host === CONFIG.allowedDomain || host.endsWith('.' + CONFIG.allowedDomain))) return;

  function severityFor(t){
    return ['gpt_not_loaded','wrong_network','slot_not_registered'].includes(t)
      ? 'high'
      : ['empty_response','unexpected_size'].includes(t)
      ? 'medium'
      : 'low';
  }

  function estimateRevenueRisk(){
    const h = (CONFIG.revenueModel.assumedImpressionsPerHour / 1000) * CONFIG.revenueModel.assumedRpm;
    return {
      estimationCurrency: CONFIG.revenueModel.currency,
      assumedRpm: CONFIG.revenueModel.assumedRpm,
      assumedImpressionsPerHour: CONFIG.revenueModel.assumedImpressionsPerHour,
      estimatedHourlyRevenueRisk: Math.round(h * 100) / 100,
      estimatedDailyRevenueRisk: Math.round(h * 24 * 100) / 100,
      estimationMethod: 'conservative_time_based_risk',
      revenueAssumptionsNote: '500 imps/hour, $1 RPM, conservative baseline'
    };
  }

  function issueKey(p){
    return [
      CONFIG.clientId,
      p.issueType,
      p.pageUrl,
      p.slotId || ''
    ].join('|').slice(0,220);
  }

  function shouldSend(p){
    try {
      const k = issueKey(p);
      const prev = localStorage.getItem(k);
      if (prev && Date.now() - Number(prev) < CONFIG.dedupeTtlMs) return false;
      localStorage.setItem(k, String(Date.now()));
      return true;
    } catch {
      return true;
    }
  }

  function sendIssue(issue){
    const payload = Object.assign({
      clientId: CONFIG.clientId,
      host: location.hostname,
      pageUrl: location.href,
      timestamp: new Date().toISOString(),
      tagVersion: CONFIG.version,
      userAgent: navigator.userAgent
    }, issue, { severity: severityFor(issue.issueType) }, estimateRevenueRisk());

    if (!shouldSend(payload)) return;

    fetch(CONFIG.apiEndpoint,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':`Bearer ${CONFIG.siteToken}`,
        'X-APG-Tag-Version':CONFIG.version
      },
      body:JSON.stringify(payload),
      keepalive:true
    }).catch(()=>{});
  }

  function scan(attempt, delayMs){
    if (!window.googletag || !googletag.apiReady) {
      if (attempt === CONFIG.scanScheduleMs.length - 1) {
        sendIssue({ issueType:'gpt_not_loaded', scanAttempt:attempt+1, scanDelayMs:delayMs });
      }
      return;
    }

    const domIds = Array.from(document.querySelectorAll(CONFIG.domSlotSelector))
      .map(el => el.id)
      .filter(Boolean);

    const gptSlots = googletag.pubads().getSlots();
    const gptIds = gptSlots.map(s => s.getSlotElementId()).filter(Boolean);

    domIds.forEach(id => {
      if (gptIds.indexOf(id) === -1) {
        sendIssue({
          issueType:'slot_not_registered',
          slotId:id,
          scanAttempt:attempt+1,
          scanDelayMs:delayMs
        });
      }
    });

    gptSlots.forEach(s => {
      const path = s.getAdUnitPath && s.getAdUnitPath();
      if (!path) return;
      const nid = path.split('/')[1];
      if (CONFIG.expectedNetworkId && nid !== CONFIG.expectedNetworkId) {
        sendIssue({
          issueType:'wrong_network',
          slotId:s.getSlotElementId(),
          adUnitPath:path,
          networkId:nid
        });
      }
    });
  }

  (window.googletag = window.googletag || { cmd: [] }).cmd.push(function(){
    const pubads = googletag.pubads();

    pubads.addEventListener('slotRenderEnded', function(e){
      const slotId = e.slot?.getSlotElementId?.() || '';
      const adUnitPath = e.slot?.getAdUnitPath?.() || '';

      if (e.isEmpty) {
        sendIssue({ issueType:'empty_response', slotId, adUnitPath });
      }

      if (e.size && e.slot?.getSizes) {
        const rendered = e.size[0] + 'x' + e.size[1];
        const defined = e.slot.getSizes().map(s => s.getWidth()+'x'+s.getHeight());
        if (defined.indexOf(rendered) === -1) {
          sendIssue({ issueType:'unexpected_size', slotId, adUnitPath, renderedSize:rendered });
        }
      }
    });
  });

  CONFIG.scanScheduleMs.forEach((ms, i) => {
    setTimeout(() => scan(i, ms), ms);
  });
})();
</script>
</body>
</html>
