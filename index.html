<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APG Simple Test Page (No GPT)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;line-height:1.35}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
    button{padding:10px 12px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    button:hover{background:#fafafa}
    .box{border:1px solid #e6e6e6;border-radius:14px;padding:14px;margin-top:14px}
    .slots{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:10px}
    .slot{border:1px dashed #bbb;border-radius:12px;min-height:90px;display:flex;align-items:center;justify-content:center;color:#666;padding:10px;text-align:center}
    .small{font-size:12px;color:#666}
    .ok{color:#0a7}
    .warn{color:#c70}
    .bad{color:#c00}
    code{background:#f4f4f6;padding:2px 6px;border-radius:6px}
    #status{white-space:pre-wrap}
  </style>
</head>
<body>
  <h1>APG Simple Test Page (No GPT / No Mock)</h1>
  <p class="small">
    Ova stranica NE koristi <code>googletag</code>. Dugmići direktno šalju APG payload na tvoj API
    (<code>/ingest</code>) da proveriš end-to-end upis u Sheet.
  </p>

  <div class="box">
    <h2>1) Slots (vizuelno)</h2>
    <div class="slots">
      <div class="slot" id="slot-ok-1">
        OK Slot #1<br><span class="small">id: slot-ok-1</span>
      </div>
      <div class="slot" id="slot-ok-2">
        OK Slot #2<br><span class="small">id: slot-ok-2</span>
      </div>
      <div class="slot" id="slot-wrong-size">
        Wrong Size Slot<br><span class="small">id: slot-wrong-size</span>
      </div>
      <div class="slot" id="slot-wrong-network">
        Wrong Network Slot<br><span class="small">id: slot-wrong-network</span>
      </div>
    </div>
  </div>

  <div class="box">
    <h2>2) Send test issues</h2>
    <p class="small">
      Svaki klik šalje 1 event na API. (Dedupe je isključen na ovoj test stranici.)
    </p>
    <div class="row">
      <button id="btn-empty">Send: empty_response</button>
      <button id="btn-unexpected-size">Send: unexpected_size</button>
      <button id="btn-wrong-network">Send: wrong_network</button>
      <button id="btn-slot-not-registered">Send: slot_not_registered</button>
      <button id="btn-gpt-not-loaded">Send: gpt_not_loaded</button>
    </div>

    <div class="box">
      <div class="small">Status:</div>
      <div id="status" class="small"></div>
    </div>
  </div>

  <script>
  (function () {
    const CONFIG = {
      clientId: 'client-001',
      allowedDomain: 'smajli12.github.io',
      apiEndpoint: 'https://apg-api.onrender.com/ingest',
      siteToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjbGllbnRJZCI6ImNsaWVudC0wMDEiLCJpYXQiOjE3NjcyMDc4NjAsImV4cCI6MTc5ODc0Mzg2MH0.75Fih1agPeA_QTK3u3qpydbLuMAfr4_TqeoApKB6tAY',
      version: 'simple-test-1.0.0',

      // ✅ Dedupe OFF for testing:
      dedupeTtlMs: 0,

      revenueModel: {
        currency: 'USD',
        assumedRpm: 1.0,
        estimationWindowHours: 24,
        assumedImpressionsPerIssue: {
          gpt_not_loaded: 80000,
          wrong_network: 60000,
          slot_not_registered: 25000,
          empty_response: 12000,
          unexpected_size: 8000
        }
      }
    };

    // strict domain check (same as your real tag)
    const host = location.hostname;
    const okDomain = (host === CONFIG.allowedDomain) || host.endsWith('.' + CONFIG.allowedDomain);
    if (!okDomain) {
      console.warn('[APG simple test] blocked by allowedDomain', host);
      return;
    }

    const statusEl = document.getElementById('status');
    function logStatus(msg) {
      statusEl.textContent = msg + "\n" + (statusEl.textContent || "");
    }

    function nowISO(){ return new Date().toISOString(); }

    function severityFor(type) {
      if (type === 'gpt_not_loaded') return 'high';
      if (type === 'wrong_network') return 'high';
      if (type === 'slot_not_registered') return 'high';
      if (type === 'empty_response') return 'medium';
      if (type === 'unexpected_size') return 'medium';
      return 'low';
    }

    function estimateRevenueAtRisk(issueType) {
      const m = CONFIG.revenueModel || {};
      const rpm = Number(m.assumedRpm);
      const imps = Number((m.assumedImpressionsPerIssue || {})[issueType] || 0);
      const safeRpm = (!Number.isFinite(rpm) || rpm < 0) ? 0 : rpm;
      const safeImps = (!Number.isFinite(imps) || imps < 0) ? 0 : imps;
      const est = (safeImps / 1000) * safeRpm;

      return {
        estimationCurrency: m.currency || 'USD',
        estimationWindowHours: m.estimationWindowHours || 24,
        assumedRpm: safeRpm,
        assumedImpressionsAtRisk: safeImps,
        estimatedRevenueAtRisk: Math.round(est * 100) / 100,
        estimationMethod: 'conservative_impressions_x_rpm'
      };
    }

    function basePayload() {
      return {
        clientId: CONFIG.clientId,
        host: location.hostname,
        pageUrl: location.href, // change ?t= to get different URLs if you want
        timestamp: nowISO(),
        tagVersion: CONFIG.version,
        userAgent: navigator.userAgent
      };
    }

    async function sendIssue(issue) {
      const payload = Object.assign(
        basePayload(),
        issue,
        { severity: severityFor(issue.issueType) },
        estimateRevenueAtRisk(issue.issueType)
      );

      try {
        const res = await fetch(CONFIG.apiEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${CONFIG.siteToken}`,
            'X-APG-Tag-Version': CONFIG.version
          },
          body: JSON.stringify(payload),
          keepalive: true
        });

        const txt = await res.text().catch(() => '');
        logStatus(`[${new Date().toLocaleTimeString()}] ${issue.issueType} -> HTTP ${res.status} ${txt}`);
      } catch (e) {
        logStatus(`[${new Date().toLocaleTimeString()}] ${issue.issueType} -> ERROR ${String(e)}`);
      }
    }

    // Buttons
    document.getElementById('btn-empty').addEventListener('click', () => {
      sendIssue({
        issueType: 'empty_response',
        slotId: 'slot-ok-1',
        adUnitPath: '/12345678/homepage/top'
      });
    });

    document.getElementById('btn-unexpected-size').addEventListener('click', () => {
      sendIssue({
        issueType: 'unexpected_size',
        slotId: 'slot-wrong-size',
        adUnitPath: '/12345678/homepage/sidebar',
        renderedSize: '300x250',
        definedSizes: ['728x90'] // defined != rendered => unexpected_size
      });
    });

    document.getElementById('btn-wrong-network').addEventListener('click', () => {
      sendIssue({
        issueType: 'wrong_network',
        slotId: 'slot-wrong-network',
        adUnitPath: '/99999999/homepage/footer', // wrong network in path
        networkId: '99999999'
      });
    });

    document.getElementById('btn-slot-not-registered').addEventListener('click', () => {
      sendIssue({
        issueType: 'slot_not_registered',
        slotId: 'slot-not-registered-xyz',
        adUnitPath: '/12345678/homepage/mid'
      });
    });

    document.getElementById('btn-gpt-not-loaded').addEventListener('click', () => {
      sendIssue({
        issueType: 'gpt_not_loaded'
      });
    });

    logStatus('[ready] Click buttons to send issues. Check Network (ingest) + Google Sheet.');
  })();
  </script>
</body>
</html>
