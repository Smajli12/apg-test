<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APG Test Page (GPT Stub)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;line-height:1.35}
    code,pre{background:#f4f4f6;padding:2px 6px;border-radius:6px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
    button{padding:10px 12px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    button:hover{background:#fafafa}
    .box{border:1px solid #e6e6e6;border-radius:14px;padding:14px;margin-top:14px}
    .slots{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:10px}
    .slot{border:1px dashed #bbb;border-radius:12px;min-height:90px;display:flex;align-items:center;justify-content:center;color:#666;padding:10px;text-align:center}
    .small{font-size:12px;color:#666}
    .ok{color:#0a7}
    .warn{color:#c70}
    .bad{color:#c00}
    #status{white-space:pre-wrap}
  </style>

  <!-- =========================================================
       0) GPT STUB (must load BEFORE APG tag)
       ========================================================= -->
  <script>
  (function () {
    // Simple in-memory pubads bus
    const listeners = { slotRenderEnded: [] };

    function makeSlot({ id, adUnitPath, sizes }) {
      return {
        getSlotElementId() { return id; },
        getAdUnitPath() { return adUnitPath; },
        getSizes() {
          // mimic GPT size objects with getWidth/getHeight
          return (sizes || []).map(([w,h]) => ({
            getWidth(){ return w; },
            getHeight(){ return h; }
          }));
        }
      };
    }

    // 3 registered slots in GPT
    const slots = [
      makeSlot({
        id: "div-gpt-ad-test-1",
        adUnitPath: "/12345678/homepage/top",
        sizes: [[728,90],[970,250]]
      }),
      makeSlot({
        id: "div-gpt-ad-test-2",
        adUnitPath: "/12345678/homepage/sidebar",
        sizes: [[300,250],[300,600]]
      }),
      makeSlot({
        id: "gpt-ad-footer",
        adUnitPath: "/12345678/homepage/footer",
        sizes: [[728,90]]
      })
    ];

    const pubadsObj = {
      addEventListener(evt, cb) {
        if (!listeners[evt]) listeners[evt] = [];
        listeners[evt].push(cb);
      },
      getSlots() { return slots; },

      // helper for stub UI
      __emitSlotRenderEnded(payload) {
        const cbs = (listeners.slotRenderEnded || []).slice(0);
        cbs.forEach(cb => {
          try { cb(payload); } catch (e) {}
        });
      }
    };

    // Create googletag stub
    const gt = window.googletag || {};
    gt.apiReady = true;

    // cmd queue – execute immediately in stub
    gt.cmd = gt.cmd || [];
    const origPush = gt.cmd.push.bind(gt.cmd);
    gt.cmd.push = function (fn) {
      origPush(fn);
      try { if (typeof fn === "function") fn(); } catch (e) {}
      return gt.cmd.length;
    };

    gt.pubads = function () { return pubadsObj; };

    window.googletag = gt;

    // Expose helper to page buttons
    window.__gptStub = {
      enable() { window.googletag.apiReady = true; },
      disable() { window.googletag.apiReady = false; },
      emitEmpty() {
        const slot = slots[0];
        pubadsObj.__emitSlotRenderEnded({
          slot,
          isEmpty: true
        });
      },
      emitUnexpectedSize() {
        const slot = slots[1];
        pubadsObj.__emitSlotRenderEnded({
          slot,
          isEmpty: false,
          size: [160, 600] // rendered not in defined sizes for this slot
        });
      },
      emitOkSize() {
        const slot = slots[1];
        pubadsObj.__emitSlotRenderEnded({
          slot,
          isEmpty: false,
          size: [300, 250] // valid
        });
      },
      emitWrongNetwork() {
        // create a slot whose adUnitPath has wrong network id
        const badSlot = makeSlot({
          id: "slot-wrong-network",
          adUnitPath: "/99999999/homepage/bad-network",
          sizes: [[300,250]]
        });
        // also register it so postLoadScan sees it in getSlots()
        slots.push(badSlot);
        pubadsObj.__emitSlotRenderEnded({
          slot: badSlot,
          isEmpty: false,
          size: [300, 250]
        });
      },
      resetWrongNetwork() {
        // remove the injected wrong-network slot if present
        for (let i = slots.length - 1; i >= 0; i--) {
          if (slots[i] && slots[i].getSlotElementId && slots[i].getSlotElementId() === "slot-wrong-network") {
            slots.splice(i, 1);
          }
        }
      }
    };

    console.log("[gpt-stub] ready, apiReady=true, slots:", slots.map(s => s.getSlotElementId()));
  })();
  </script>

  <!-- =========================================================
       1) YOUR REAL APG TAG (as-is, with minimal config filled)
       ========================================================= -->
  <script>
  (function () {
    const CONFIG = {
      clientId: 'client-001',
      allowedDomain: 'smajli12.github.io',
      expectedNetworkId: '12345678',
      apiEndpoint: 'https://apg-api.onrender.com/ingest',
      siteToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjbGllbnRJZCI6ImNsaWVudC0wMDEiLCJpYXQiOjE3NjcyMDc4NjAsImV4cCI6MTc5ODc0Mzg2MH0.75Fih1agPeA_QTK3u3qpydbLuMAfr4_TqeoApKB6tAY',
      version: 'start-1.0.3',

      sendTimeoutMs: 4000,
      dedupeTtlMs: 24 * 60 * 60 * 1000, // 24h
      postLoadDelayMs: 3500,

      domSlotSelector: 'div[id^="div-gpt-ad"],div[id^="gpt-"],div[id^="ad-"],div[id*="ad-slot"],div[id*="gpt-ad"],div[id*="slot"]',

      revenueModel: {
        currency: 'USD',
        assumedRpm: 1.0,
        estimationWindowHours: 24,
        assumedImpressionsPerIssue: {
          gpt_not_loaded: 80000,
          wrong_network: 60000,
          slot_not_registered: 25000,
          empty_response: 12000,
          unexpected_size: 8000
        }
      }
    };

    // Strict domain check
    const host = location.hostname;
    const okDomain = (host === CONFIG.allowedDomain) || host.endsWith('.' + CONFIG.allowedDomain);
    if (!okDomain) return;

    function nowISO(){ return new Date().toISOString(); }

    function issueKey(payload) {
      const parts = [
        CONFIG.clientId,
        payload.issueType,
        payload.pageUrl,
        payload.slotId || '',
        payload.adUnitPath || ''
      ];
      return 'apg_' + parts.join('|').slice(0, 220);
    }

    function shouldSend(payload) {
      try {
        const k = issueKey(payload);
        const prev = localStorage.getItem(k);
        if (prev) {
          const ts = Number(prev);
          if (!Number.isNaN(ts) && (Date.now() - ts) < CONFIG.dedupeTtlMs) return false;
        }
        localStorage.setItem(k, String(Date.now()));
        return true;
      } catch (_) {
        return true;
      }
    }

    function severityFor(type) {
      if (type === 'gpt_not_loaded') return 'high';
      if (type === 'wrong_network') return 'high';
      if (type === 'slot_not_registered') return 'high';
      if (type === 'empty_response') return 'medium';
      if (type === 'unexpected_size') return 'medium';
      return 'low';
    }

    function estimateRevenueAtRisk(issueType) {
      try {
        const m = CONFIG.revenueModel || {};
        const rpm = Number(m.assumedRpm);
        const imps = Number((m.assumedImpressionsPerIssue || {})[issueType] || 0);

        const safeRpm = (!Number.isFinite(rpm) || rpm < 0) ? 0 : rpm;
        const safeImps = (!Number.isFinite(imps) || imps < 0) ? 0 : imps;

        const est = (safeImps / 1000) * safeRpm;

        return {
          estimationCurrency: m.currency || 'USD',
          estimationWindowHours: m.estimationWindowHours || 24,
          assumedRpm: safeRpm,
          assumedImpressionsAtRisk: safeImps,
          estimatedRevenueAtRisk: Math.round(est * 100) / 100,
          estimationMethod: 'conservative_impressions_x_rpm'
        };
      } catch (_) {
        return {
          estimationCurrency: 'USD',
          estimationWindowHours: 24,
          assumedRpm: 0,
          assumedImpressionsAtRisk: 0,
          estimatedRevenueAtRisk: 0,
          estimationMethod: 'conservative_impressions_x_rpm'
        };
      }
    }

    function basePayload() {
      return {
        clientId: CONFIG.clientId,
        host: location.hostname,
        pageUrl: location.href,
        timestamp: nowISO(),
        tagVersion: CONFIG.version,
        userAgent: navigator.userAgent
      };
    }

    async function sendIssue(issue) {
      if (!CONFIG.apiEndpoint) return;

      const payload = Object.assign(
        basePayload(),
        issue,
        { severity: severityFor(issue.issueType) },
        estimateRevenueAtRisk(issue.issueType)
      );

      if (!shouldSend(payload)) return;

      const ctrl = (typeof AbortController !== 'undefined') ? new AbortController() : null;
      const t = ctrl ? setTimeout(() => ctrl.abort(), CONFIG.sendTimeoutMs) : null;

      try {
        await fetch(CONFIG.apiEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type':'application/json',
            'Authorization': `Bearer ${CONFIG.siteToken}`,
            'X-APG-Tag-Version': CONFIG.version
          },
          body: JSON.stringify(payload),
          keepalive: true,
          signal: ctrl ? ctrl.signal : undefined
        });
      } catch (_) {
        // never break page
      } finally {
        if (t) clearTimeout(t);
      }
    }

    function attachGptListeners() {
      (window.googletag = window.googletag || { cmd: [] }).cmd.push(function () {
        if (!(window.googletag && googletag.apiReady)) return;

        const pubads = googletag.pubads();
        if (pubads.__apgStartBound) return;
        pubads.__apgStartBound = true;

        pubads.addEventListener('slotRenderEnded', function (e) {
          try {
            const slot = e && e.slot;
            const slotId = slot && slot.getSlotElementId ? slot.getSlotElementId() : '';
            const adUnitPath = slot && slot.getAdUnitPath ? slot.getAdUnitPath() : '';

            if (e.isEmpty === true) {
              sendIssue({ issueType:'empty_response', slotId, adUnitPath });
              return;
            }

            if (e.size && Array.isArray(e.size) && slot && slot.getSizes) {
              const rendered = e.size[0] + 'x' + e.size[1];
              const defined = (slot.getSizes() || []).map(s => {
                try { return s.getWidth() + 'x' + s.getHeight(); } catch (_) { return null; }
              }).filter(Boolean);

              if (defined.length && defined.indexOf(rendered) === -1) {
                sendIssue({
                  issueType:'unexpected_size',
                  slotId,
                  adUnitPath,
                  renderedSize: rendered,
                  definedSizes: defined.slice(0, 20)
                });
              }
            }
          } catch (_) {}
        });
      });
    }

    function collectDomSlotIds() {
      try {
        return Array.from(document.querySelectorAll(CONFIG.domSlotSelector))
          .map(el => el && el.id)
          .filter(Boolean);
      } catch (_) {
        return [];
      }
    }

    function postLoadScan() {
      if (!window.googletag || !googletag.apiReady) {
        sendIssue({ issueType:'gpt_not_loaded' });
        return;
      }

      try {
        const domIds = collectDomSlotIds();
        const slots = googletag.pubads().getSlots();
        const gptIds = slots.map(s => s.getSlotElementId()).filter(Boolean);

        if (domIds && domIds.length) {
          domIds.forEach(function (id) {
            if (gptIds.indexOf(id) === -1) {
              sendIssue({ issueType:'slot_not_registered', slotId: id });
            }
          });
        }

        if (CONFIG.expectedNetworkId) {
          slots.forEach(function (s) {
            const adUnitPath = (s.getAdUnitPath && s.getAdUnitPath()) || '';
            if (!adUnitPath) return;

            const nid = (adUnitPath.split('/')[1] || '');
            if (nid && nid !== CONFIG.expectedNetworkId) {
              const slotId = (s.getSlotElementId && s.getSlotElementId()) || '';
              sendIssue({ issueType:'wrong_network', slotId, adUnitPath, networkId: nid });
            }
          });
        }
      } catch (_) {}
    }

    function init() {
      attachGptListeners();
      window.addEventListener('load', function () {
        setTimeout(postLoadScan, CONFIG.postLoadDelayMs);
      });
    }

    try { init(); } catch (_) {}
  })();
  </script>
  <!-- ========================================================= -->

</head>

<body>
  <h1>APG Test Page (GPT Stub)</h1>
  <p class="small">
    Ovo je “Phase 2” test: tvoj real APG tag sluša <code>slotRenderEnded</code>, ali GPT je stubovan.
  </p>

  <div class="box">
    <h2>Slots in DOM</h2>
    <p class="small">
      DOM slotovi (1 je namerno “ne-registriran” u GPT stub-u).
    </p>
    <div class="slots">
      <div class="slot" id="div-gpt-ad-test-1">Registered slot<br><span class="small">div-gpt-ad-test-1</span></div>
      <div class="slot" id="div-gpt-ad-test-2">Registered slot<br><span class="small">div-gpt-ad-test-2</span></div>
      <div class="slot" id="gpt-ad-footer">Registered slot<br><span class="small">gpt-ad-footer</span></div>
      <div class="slot" id="ad-slot-not-registered">NOT registered in GPT<br><span class="small">ad-slot-not-registered</span></div>
    </div>
    <p class="small warn">
      Ovaj <code>ad-slot-not-registered</code> treba da okine <code>slot_not_registered</code> na postLoadScan.
    </p>
  </div>

  <div class="box">
    <h2>Trigger slotRenderEnded events (from stub)</h2>
    <div class="row">
      <button onclick="__gptStub.enable(); console.log('stub apiReady=true');">Enable GPT (apiReady=true)</button>
      <button onclick="__gptStub.disable(); console.log('stub apiReady=false');">Disable GPT (apiReady=false)</button>
    </div>

    <div class="row">
      <button onclick="__gptStub.emitEmpty();">Emit: empty_response</button>
      <button onclick="__gptStub.emitUnexpectedSize();">Emit: unexpected_size</button>
      <button onclick="__gptStub.emitOkSize();">Emit: ok render (no event expected)</button>
      <button onclick="__gptStub.emitWrongNetwork();">Inject+Emit: wrong_network</button>
      <button onclick="__gptStub.resetWrongNetwork(); console.log('wrong_network slot removed');">Reset wrong_network slot</button>
    </div>

    <p class="small">
      Otvori DevTools → Network → filter <code>ingest</code>.  
      Klikni dugme → treba da vidiš POST /ingest i red u Sheet-u.
    </p>

    <p class="small warn">
      Ako klikćeš isto više puta, dedupe (24h) može blokirati. Rešenje: otvori stranicu sa <code>?t=123</code> ili obriši localStorage.
    </p>
  </div>

</body>
</html>
