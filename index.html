<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>APG Tag Test Page (Mock GPT)</title>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;line-height:1.35}
    code,pre{background:#f4f4f6;padding:2px 6px;border-radius:6px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
    button{padding:10px 12px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    button:hover{background:#fafafa}
    .box{border:1px solid #e6e6e6;border-radius:14px;padding:14px;margin-top:14px}
    .slots{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:10px}
    .slot{border:1px dashed #bbb;border-radius:12px;min-height:90px;display:flex;align-items:center;justify-content:center;color:#666}
    .small{font-size:12px;color:#666}
    .ok{color:#0a7}
    .warn{color:#c70}
  </style>

  <!-- ================= APG TAG (OVDE IDE) ================= -->
  <script>
  (function () {
    const CONFIG = {
      clientId: 'client-001',
      allowedDomain: 'smajli12.github.io',
      expectedNetworkId: '12345678',
      apiEndpoint: 'https://apg-api.onrender.com/ingest',
      siteToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjbGllbnRJZCI6ImNsaWVudC0wMDEiLCJpYXQiOjE3NjcxOTU0NTYsImV4cCI6MTc5ODczMTQ1Nn0.-JSEf0OWS5qPG3UzxtyWDdZ28SbZ75G3ChnwutY8icQ',
      version: 'start-1.0.3',

      sendTimeoutMs: 4000,
      dedupeTtlMs: 24 * 60 * 60 * 1000,
      postLoadDelayMs: 3500,

      domSlotSelector: 'div[id^="div-gpt-ad"],div[id^="gpt-"],div[id^="ad-"],div[id*="ad-slot"],div[id*="gpt-ad"],div[id*="slot"]'
    };

    const host = location.hostname;
    const okDomain = (host === CONFIG.allowedDomain) || host.endsWith('.' + CONFIG.allowedDomain);
    if (!okDomain) return;

    function nowISO(){ return new Date().toISOString(); }

    function issueKey(p){
      return 'apg_' + [CONFIG.clientId,p.issueType,p.pageUrl,p.slotId||'',p.adUnitPath||'']
        .join('|').slice(0,220);
    }

    function shouldSend(p){
      try{
        const k=issueKey(p);
        const prev=localStorage.getItem(k);
        if(prev && Date.now()-Number(prev)<CONFIG.dedupeTtlMs) return false;
        localStorage.setItem(k,String(Date.now()));
        return true;
      }catch{ return true; }
    }

    async function sendIssue(issue){
      const payload={
        clientId:CONFIG.clientId,
        host:location.hostname,
        pageUrl:location.href,
        timestamp:nowISO(),
        tagVersion:CONFIG.version,
        userAgent:navigator.userAgent,
        ...issue
      };
      if(!shouldSend(payload)) return;

      try{
        await fetch(CONFIG.apiEndpoint,{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':`Bearer ${CONFIG.siteToken}`,
            'X-APG-Tag-Version':CONFIG.version
          },
          body:JSON.stringify(payload),
          keepalive:true
        });
      }catch{}
    }

    // minimal sanity ping
    window.addEventListener('load',()=>{
      setTimeout(()=>sendIssue({issueType:'gpt_not_loaded',severity:'high'}),1200);
    });
  })();
  </script>
  <!-- ================= END APG TAG ================= -->

</head>
<body>

  <h1>APG Tag Test Page</h1>

  <p class="small">
    This page is designed to test your GTM tag without a real GAM setup.
    It includes <b>mock GPT</b> that can trigger the same events your tag listens for.
  </p>

  <div class="box">
    <h2>1) Mock GPT Controls</h2>
    <div class="row">
      <button id="btn-enable-mock">Enable Mock GPT (apiReady=true)</button>
      <button id="btn-disable-gpt">Disable GPT (simulate gpt_not_loaded)</button>
    </div>

    <h3>Trigger Issues</h3>
    <div class="row">
      <button id="btn-slot-not-registered">Trigger: slot_not_registered</button>
      <button id="btn-wrong-network">Trigger: wrong_network</button>
      <button id="btn-empty">Trigger: empty_response</button>
      <button id="btn-unexpected-size">Trigger: unexpected_size</button>
    </div>
  </div>

  <div class="box">
    <h2>2) Ad Slots on the Page</h2>
    <div class="slots">
      <div class="slot" id="div-gpt-ad-test-1">div-gpt-ad-test-1</div>
      <div class="slot" id="div-gpt-ad-test-2">div-gpt-ad-test-2</div>
      <div class="slot" id="ad-slot-hero">ad-slot-hero</div>
      <div class="slot" id="gpt-ad-footer">gpt-ad-footer</div>
    </div>
  </div>

  <script src="./assets/mock-gpt.js"></script>
  <script src="./assets/app.js"></script>

</body>
</html>
